@model SAFA_ECC_Core_Clean.ViewModels.PasswordPolicyViewModel
@{
    ViewData["Title"] = "إدارة سياسات كلمة المرور";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <h4 class="page-title">إدارة سياسات كلمة المرور</h4>
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="javascript: void(0);">الرئيسية</a></li>
                        <li class="breadcrumb-item"><a href="@Url.Action("Index")">الإدارة</a></li>
                        <li class="breadcrumb-item active">سياسات كلمة المرور</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="mdi mdi-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="mdi mdi-alert-circle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <!-- نموذج إضافة سياسة جديدة -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title">إضافة سياسة كلمة مرور جديدة</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Add_Password_Policies" method="post">
                        @Html.AntiForgeryToken()
                        
                        <div class="mb-3">
                            <label asp-for="PolicyName" class="form-label">اسم السياسة <span class="text-danger">*</span></label>
                            <input asp-for="PolicyName" class="form-control" placeholder="أدخل اسم السياسة" required>
                            <span asp-validation-for="PolicyName" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="MinimumLength" class="form-label">الحد الأدنى للطول</label>
                                    <input asp-for="MinimumLength" type="number" class="form-control" min="1" max="50" value="8">
                                    <span asp-validation-for="MinimumLength" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="MaxLength" class="form-label">الحد الأقصى للطول</label>
                                    <input asp-for="MaxLength" type="number" class="form-control" min="1" max="100" value="50">
                                    <span asp-validation-for="MaxLength" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">متطلبات كلمة المرور</label>
                            <div class="form-check">
                                <input asp-for="RequireUppercase" class="form-check-input" type="checkbox" id="requireUppercase">
                                <label class="form-check-label" for="requireUppercase">
                                    يجب أن تحتوي على أحرف كبيرة (A-Z)
                                </label>
                            </div>
                            <div class="form-check">
                                <input asp-for="RequireLowercase" class="form-check-input" type="checkbox" id="requireLowercase">
                                <label class="form-check-label" for="requireLowercase">
                                    يجب أن تحتوي على أحرف صغيرة (a-z)
                                </label>
                            </div>
                            <div class="form-check">
                                <input asp-for="RequireNumbers" class="form-check-input" type="checkbox" id="requireNumbers">
                                <label class="form-check-label" for="requireNumbers">
                                    يجب أن تحتوي على أرقام (0-9)
                                </label>
                            </div>
                            <div class="form-check">
                                <input asp-for="RequireSpecialChars" class="form-check-input" type="checkbox" id="requireSpecialChars">
                                <label class="form-check-label" for="requireSpecialChars">
                                    يجب أن تحتوي على رموز خاصة (!&#64;&#36;%)</label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="PasswordExpiryDays" class="form-label">انتهاء صلاحية كلمة المرور (أيام)</label>
                                    <input asp-for="PasswordExpiryDays" type="number" class="form-control" min="0" max="365" value="90">
                                    <small class="form-text text-muted">0 = لا تنتهي الصلاحية</small>
                                    <span asp-validation-for="PasswordExpiryDays" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="PasswordHistoryCount" class="form-label">عدد كلمات المرور المحفوظة</label>
                                    <input asp-for="PasswordHistoryCount" type="number" class="form-control" min="0" max="24" value="5">
                                    <small class="form-text text-muted">لمنع إعادة استخدام كلمات المرور السابقة</small>
                                    <span asp-validation-for="PasswordHistoryCount" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="MaxLoginAttempts" class="form-label">الحد الأقصى لمحاولات تسجيل الدخول</label>
                                    <input asp-for="MaxLoginAttempts" type="number" class="form-control" min="1" max="10" value="3">
                                    <span asp-validation-for="MaxLoginAttempts" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="LockoutDurationMinutes" class="form-label">مدة القفل (دقائق)</label>
                                    <input asp-for="LockoutDurationMinutes" type="number" class="form-control" min="1" max="1440" value="30">
                                    <span asp-validation-for="LockoutDurationMinutes" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-content-save me-1"></i>
                                حفظ السياسة
                            </button>
                            <a href="@Url.Action("password_policylist")" class="btn btn-secondary">
                                <i class="mdi mdi-format-list-bulleted me-1"></i>
                                عرض جميع السياسات
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- قائمة السياسات الموجودة -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title">السياسات الموجودة</h4>
                </div>
                <div class="card-body">
                    @if (Model.ExistingPolicies != null && Model.ExistingPolicies.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>اسم السياسة</th>
                                        <th>الطول</th>
                                        <th>المتطلبات</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var policy in Model.ExistingPolicies)
                                    {
                                        <tr>
                                            <td>@policy.Policy_Name</td>
                                            <td>@policy.Min_Length - @policy.Max_Length</td>
                                            <td>
                                                @if (policy.Require_Uppercase == true) { <span class="badge bg-info me-1">A-Z</span> }
                                                @if (policy.Require_Lowercase == true) { <span class="badge bg-info me-1">a-z</span> }
                                                @if (policy.Require_Numbers == true) { <span class="badge bg-info me-1">0-9</span> }
                                                 @if (policy.Require_Special_Chars == true) { <span class="badge bg-info me-1">!&#64;&#36;&#37;</span> }
                                            </td>
                                            <td>
                                                @if (policy.Is_Active == true)
                                                {
                                                    <span class="badge bg-success">نشط</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">غير نشط</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="@Url.Action("EditPassword_Policy", new { id = policy.Policy_ID })" class="btn btn-outline-primary btn-sm">
                                                        <i class="mdi mdi-pencil"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-outline-danger btn-sm"onclick="deletePolicy(@policy.Policy_ID)">
                                                        <i class="mdi mdi-delete"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="mdi mdi-shield-lock-outline display-4 text-muted"></i>
                            <h5 class="mt-3">لا توجد سياسات</h5>
                            <p class="text-muted">لم يتم إنشاء أي سياسات كلمة مرور بعد.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- معاينة السياسة -->
            <div class="card">
                <div class="card-header">
                    <h4 class="header-title">معاينة السياسة</h4>
                </div>
                <div class="card-body">
                    <div id="policyPreview">
                        <p class="text-muted">قم بملء النموذج لمعاينة السياسة</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // معاينة السياسة عند تغيير القيم
            jQuery(\'input\').on(\'input change\', function() {
                updatePolicyPreview();
            });
            
            updatePolicyPreview();
        });

        function updatePolicyPreview() {
            let preview = '<h6>متطلبات كلمة المرور:</h6><ul>';
            
             let minLength = document.getElementById(\'MinimumLength\').value || 8;           let maxLength = document.getElementById('MaxLength').value || 50;
            preview += `<li>الطول: بين ${minLength} و ${maxLength} حرف</li>`;
            
if (document.getElementById(\'requireLowercase\').checked) {
                preview += \'<li>يجب أن تحتوي على أحرف صغيرة (a-z)</li>\';
            }
            
            if (document.getElementById('requireUppercase').checked) {
                preview += '<li>يجب أن تحتوي على أحرف كبيرة (A-Z)</li>';
            }
            
            if (document.getElementById('requireNumbers').checked) {
                preview += '<li>يجب أن تحتوي على أرقام (0-9)</li>';
            }
            
            if (document.getElementById('requireSpecialChars').checked) {
                preview += '<li>يجب أن تحتوي على رموز خاصة (!&#64;&#36;%)</li>';
            }
            
            let expiryDays = document.getElementById(\'PasswordExpiryDays\').value || 90;
            if (expiryDays > 0) {
                preview += `<li>تنتهي صلاحية كلمة المرور بعد ${expiryDays} يوم</li>`;
            } else {
                preview += '<li>كلمة المرور لا تنتهي صلاحيتها</li>';
            }
            
          let historyCount = document.getElementById(\'PasswordHistoryCount\').value || 5;
            if (historyCount > 0) {
                preview += `<li>لا يمكن إعادة استخدام آخر ${historyCount} كلمات مرور</li>`;
            }
            
            let maxAttempts = $(\'#MaxLoginAttempts\').val() || 3;
            let lockoutDuration = $('#LockoutDurationMinutes').val() || 30;
            preview += `<li>يتم قفل الحساب بعد ${maxAttempts} محاولات فاشلة لمدة ${lockoutDuration} دقيقة</li>`;
            
            preview += '</ul>';
            
            $('#policyPreview').html(preview);
        }

        function deletePolicy(policyId) {
            if (confirm('هل أنت متأكد من حذف هذه السياسة؟')) {
                // إضافة منطق الحذف هنا
                window.location.href = '@Url.Action("DeletePasswordPolicy")' + '?id=' + policyId;
            }
        }
    </script>
}

<style>
    .form-check {
        margin-bottom: 0.5rem;
    }
    
    .badge {
        font-size: 0.7em;
    }
    
    #policyPreview ul {
        margin-bottom: 0;
    }
    
    #policyPreview li {
        margin-bottom: 0.25rem;
    }
</style>

